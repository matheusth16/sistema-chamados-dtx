{% extends "base.html" %}

{% block content %}

<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-xl mx-auto px-4">

        <!-- Cabeçalho -->
        <div class="mb-6">
            <a href="{{ url_for('main.gerenciar_usuarios') }}"
                class="text-sm text-blue-600 hover:underline mb-2 inline-block">{{ t('back_to_user_list') }}</a>
            {% if usuario %}
            <h1 class="text-2xl font-bold text-gray-900">{{ t('edit_user') }}</h1>
            <p class="text-sm text-gray-500 mt-1">{{ t('change_user_data') }}</p>
            {% else %}
            <h1 class="text-2xl font-bold text-gray-900">{{ t('new_user') }}</h1>
            <p class="text-sm text-gray-500 mt-1">{{ t('fill_new_user_data') }}</p>
            {% endif %}
        </div>

        <!-- Card do Formulário -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">

            {% if usuario %}
            <!-- Header Editar -->
            <div class="bg-purple-600 text-white px-6 py-4">
                <h2 class="text-lg font-semibold">{{ t('edit_user') }}</h2>
                <p class="text-sm text-purple-100">{{ t('change_user_data') }}</p>
            </div>
            {% else %}
            <!-- Header Criar -->
            <div class="bg-blue-600 text-white px-6 py-4">
                <h2 class="text-lg font-semibold">{{ t('new_user') }}</h2>
                <p class="text-sm text-blue-100">{{ t('fill_new_user_data') }}</p>
            </div>
            {% endif %}

            <form method="POST"
                action="{% if usuario %}{{ url_for('main.editar_usuario', usuario_id=usuario.id) }}{% else %}{{ url_for('main.gerenciar_usuarios') }}{% endif %}"
                class="p-6 space-y-5">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                {% if not usuario %}
                <input type="hidden" name="acao" value="criar">
                {% endif %}

                <!-- Email -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('email_required') }}</label>
                    <input type="email" name="email" required value="{{ usuario.email if usuario else '' }}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="{{ t('ex_email') }}">
                </div>

                <!-- Nome -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('full_name_required') }}</label>
                    <input type="text" name="nome" required minlength="3" value="{{ usuario.nome if usuario else '' }}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="{{ t('ex_name') }}">
                </div>

                <!-- Perfil -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('profile_required') }}</label>
                    <select name="perfil" id="perfilSelect" required onchange="toggleArea()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="solicitante" {% if usuario and usuario.perfil=='solicitante' %}selected{% endif
                            %}>{{ t('requester_creates_tickets') }}</option>
                        <option value="supervisor" {% if usuario and usuario.perfil=='supervisor' %}selected{% endif %}>
                            {{ t('supervisor_manages_area') }}</option>
                        <option value="admin" {% if usuario and usuario.perfil=='admin' %}selected{% endif %}>{{ t('admin_full_access') }}</option>
                    </select>
                </div>

                <!-- Áreas (visível apenas para supervisor e admin) -->
                <div id="areaDiv" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ t('areas_sectors_select_one_or_more') }}</label>
                    <div class="grid grid-cols-2 gap-2 bg-gray-50 p-3 rounded-md border border-gray-300">
                        {% set areas_usuario = usuario.areas if usuario and usuario.areas else [] %}
                        <label class="inline-flex items-center"><input type="checkbox" name="areas" value="Manutencao"
                                class="form-checkbox text-blue-600 rounded" {% if 'Manutencao' in areas_usuario
                                %}checked{% endif %}> <span class="ml-2 text-sm text-gray-700">{{ t('area_maintenance') }}</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="areas" value="Engenharia"
                                class="form-checkbox text-blue-600 rounded" {% if 'Engenharia' in areas_usuario
                                %}checked{% endif %}> <span class="ml-2 text-sm text-gray-700">{{ t('area_engineering') }}</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="areas" value="Qualidade"
                                class="form-checkbox text-blue-600 rounded" {% if 'Qualidade' in areas_usuario
                                %}checked{% endif %}> <span class="ml-2 text-sm text-gray-700">{{ t('area_quality') }}</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="areas" value="Comercial"
                                class="form-checkbox text-blue-600 rounded" {% if 'Comercial' in areas_usuario
                                %}checked{% endif %}> <span class="ml-2 text-sm text-gray-700">{{ t('area_commercial') }}</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="areas" value="Planejamento"
                                class="form-checkbox text-blue-600 rounded" {% if 'Planejamento' in areas_usuario
                                %}checked{% endif %}> <span
                                class="ml-2 text-sm text-gray-700">{{ t('area_planning') }}</span></label>
                        <label class="inline-flex items-center"><input type="checkbox" name="areas" value="Material"
                                class="form-checkbox text-blue-600 rounded" {% if 'Material' in areas_usuario
                                %}checked{% endif %}> <span class="ml-2 text-sm text-gray-700">{{ t('area_material') }}</span></label>
                    </div>
                </div>

                <!-- Senha -->
                <div>
                    {% if usuario %}
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('new_password_leave_blank') }}</label>
                    <input type="password" name="senha" minlength="6"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="{{ t('leave_blank_to_keep_current') }}">
                    {% else %}
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ t('password_required') }}</label>
                    <input type="password" name="senha" required minlength="6"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        placeholder="{{ t('minimum_6_chars') }}">
                    {% endif %}
                </div>

                <!-- Botões -->
                <div class="flex gap-3 justify-end pt-4 border-t border-gray-200">
                    <a href="{{ url_for('main.gerenciar_usuarios') }}"
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-md transition">
                        {{ t('cancel') }}
                    </a>
                    {% if usuario %}
                    <button type="submit"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-md transition">
                        {{ t('save_changes') }}
                    </button>
                    {% else %}
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition">
                        {{ t('create_user_btn') }}
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleArea() {
        const perfil = document.getElementById('perfilSelect').value;
        const areaDiv = document.getElementById('areaDiv');
        if (perfil === 'solicitante') {
            areaDiv.classList.add('hidden');
        } else {
            areaDiv.classList.remove('hidden');
        }
    }
    // Executar na carga para mostrar áreas se perfil já é supervisor/admin
    toggleArea();
</script>

{% endblock %}