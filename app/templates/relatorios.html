{% extends "base.html" %}

{% block content %}
<style>
    /* Otimizações de performance */
    canvas {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    .chart-container {
        contain: layout style paint;
    }

    /* ── Insight Cards Premium Animations ── */
    @keyframes insight-shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    @keyframes pulse-glow {
        0%, 100% { opacity: 0.4; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.05); }
    }
    .insight-card {
        transition: transform 0.35s cubic-bezier(.22,.61,.36,1), box-shadow 0.35s cubic-bezier(.22,.61,.36,1);
    }
    .insight-card:hover {
        transform: translateY(-4px) scale(1.01);
    }
    .insight-card .insight-shimmer {
        position: absolute; inset: 0;
        background: linear-gradient(105deg, transparent 40%, rgba(255,255,255,0.35) 50%, transparent 60%);
        opacity: 0;
        transition: opacity 0.3s;
    }
    .insight-card:hover .insight-shimmer {
        opacity: 1;
        animation: insight-shimmer 1.6s ease-in-out infinite;
    }
    .insight-card .insight-orb {
        position: absolute;
        border-radius: 9999px;
        filter: blur(50px);
        pointer-events: none;
        animation: pulse-glow 4s ease-in-out infinite;
    }
    .insight-card .insight-icon-badge {
        transition: transform 0.35s cubic-bezier(.22,.61,.36,1), box-shadow 0.35s cubic-bezier(.22,.61,.36,1);
    }
    .insight-card:hover .insight-icon-badge {
        transform: scale(1.12) rotate(-3deg);
    }
    .insight-card .insight-metric-value {
        transition: transform 0.3s, letter-spacing 0.3s;
    }
    .insight-card:hover .insight-metric-value {
        transform: scale(1.05);
        letter-spacing: 0.02em;
    }
</style>

<div class="space-y-6">
    
    <!-- Indicador de carregamento -->
    <div id="loading-charts" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 rounded-xl" style="display: none;">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-2"></div>
            <p class="text-gray-600 font-medium tracking-wide">{{ t('generating_reports') }}</p>
        </div>
    </div>

    <!-- Cabeçalho -->
    <div class="gsap-animate bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-blue-50 p-3 rounded-xl text-blue-600">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            </div>
            <div>
                <h1 class="text-2xl font-black text-gray-800 tracking-tight">{{ t('reports_analysis') }}</h1>
                <p class="text-sm text-gray-500 font-medium">{{ t('reports_subtitle') }}</p>
            </div>
        </div>
        <a href="{{ url_for('main.relatorios', atualizar=1) }}"
           class="inline-flex items-center px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white font-medium rounded-lg shadow transition text-sm whitespace-nowrap">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            {{ t('refresh_data') }}
        </a>
    </div>

    <!-- INSIGHTS E ALERTAS -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
            <span class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-2 rounded-xl mr-3 shadow-md shadow-blue-200" aria-hidden="true">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </span>
            {{ t('insights_alerts') }}
        </h2>
        <div class="gsap-scroll-reveal-stagger flex flex-wrap gap-5">
            {% for insight in insights %}
            <div class="insight-card gsap-scroll-reveal-item flex-1 min-w-full md:min-w-[calc(50%-1.25rem)] lg:min-w-[calc(33.333%-1.25rem)] max-w-full relative overflow-hidden rounded-2xl min-h-[170px] flex flex-col cursor-default
                {% if insight.tipo == 'aviso' %}
                    bg-gradient-to-br from-amber-50 via-orange-50/60 to-white border border-amber-200/60 shadow-sm hover:shadow-xl hover:shadow-amber-100/60
                {% elif insight.tipo == 'sucesso' %}
                    bg-gradient-to-br from-emerald-50 via-teal-50/60 to-white border border-emerald-200/60 shadow-sm hover:shadow-xl hover:shadow-emerald-100/60
                {% else %}
                    bg-gradient-to-br from-blue-50 via-indigo-50/60 to-white border border-blue-200/60 shadow-sm hover:shadow-xl hover:shadow-blue-100/60
                {% endif %}">

                <!-- Decorative orb -->
                <div class="insight-orb
                    {% if insight.tipo == 'aviso' %}bg-amber-300/30
                    {% elif insight.tipo == 'sucesso' %}bg-emerald-300/30
                    {% else %}bg-blue-300/30{% endif %}"
                    style="width: 120px; height: 120px; top: -30px; right: -30px;"></div>

                <!-- Shimmer overlay -->
                <div class="insight-shimmer rounded-2xl"></div>

                <!-- Top accent bar -->
                <div class="absolute top-0 left-0 right-0 h-1 rounded-t-2xl
                    {% if insight.tipo == 'aviso' %}bg-gradient-to-r from-amber-400 via-orange-400 to-amber-300
                    {% elif insight.tipo == 'sucesso' %}bg-gradient-to-r from-emerald-400 via-teal-400 to-emerald-300
                    {% else %}bg-gradient-to-r from-blue-400 via-indigo-400 to-blue-300{% endif %}"></div>

                <div class="relative z-10 p-5 pt-6 flex-1 flex flex-col">
                    <!-- Header with icon badge -->
                    <div class="flex items-start gap-3.5 mb-3">
                        <div class="insight-icon-badge shrink-0 w-11 h-11 rounded-xl flex items-center justify-center shadow-md backdrop-blur-sm
                            {% if insight.tipo == 'aviso' %}
                                bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow-amber-200/50
                            {% elif insight.tipo == 'sucesso' %}
                                bg-gradient-to-br from-emerald-400 to-teal-500 text-white shadow-emerald-200/50
                            {% else %}
                                bg-gradient-to-br from-blue-400 to-indigo-500 text-white shadow-blue-200/50
                            {% endif %}">
                            {% if insight.tipo == 'aviso' %}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            {% elif insight.tipo == 'sucesso' %}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                            {% else %}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            {% endif %}
                        </div>
                        <div class="min-w-0 flex-1">
                            <h3 class="font-extrabold text-gray-800 text-base leading-snug tracking-tight">
                                {{ t(insight.titulo_key, **(insight.mensagem_params or {})) }}
                            </h3>
                            <span class="inline-block mt-1.5 text-[10px] font-bold uppercase tracking-widest px-2 py-0.5 rounded-full
                                {% if insight.tipo == 'aviso' %}bg-amber-100 text-amber-700
                                {% elif insight.tipo == 'sucesso' %}bg-emerald-100 text-emerald-700
                                {% else %}bg-blue-100 text-blue-700{% endif %}">
                                {% if insight.tipo == 'aviso' %}⚠ Alerta
                                {% elif insight.tipo == 'sucesso' %}✓ OK
                                {% else %}ℹ Info{% endif %}
                            </span>
                        </div>
                    </div>

                    <!-- Description -->
                    <p class="text-sm text-gray-600 leading-relaxed line-clamp-3 flex-1">
                        {{ t(insight.mensagem_key, **(insight.mensagem_params or {})) }}
                    </p>

                    <!-- Metric footer -->
                    {% if insight.metrica_key %}
                    <div class="mt-4 pt-3 border-t flex items-center justify-between gap-2
                        {% if insight.tipo == 'aviso' %}border-amber-100/80
                        {% elif insight.tipo == 'sucesso' %}border-emerald-100/80
                        {% else %}border-blue-100/80{% endif %}">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest shrink-0">{{ t('impact_metric') }}</span>
                        <span class="insight-metric-value text-sm font-extrabold px-3 py-1 rounded-lg text-right
                            {% if insight.tipo == 'aviso' %}bg-amber-100/70 text-amber-800 ring-1 ring-amber-200/50
                            {% elif insight.tipo == 'sucesso' %}bg-emerald-100/70 text-emerald-800 ring-1 ring-emerald-200/50
                            {% else %}bg-blue-100/70 text-blue-800 ring-1 ring-blue-200/50{% endif %}">
                            {{ t(insight.metrica_key, **(insight.metrica_params or {})) }}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <p class="col-span-full text-gray-500 text-sm py-8 text-center bg-gray-50/50 rounded-2xl border border-gray-100 border-dashed">
                {{ t('no_insights') }}
            </p>
            {% endfor %}
        </div>
    </div>

    <!-- MÉTRICAS GERAIS (Visão Geral) -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-5 flex items-center">
            <span class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-2 rounded-xl mr-3 shadow-md shadow-purple-200" aria-hidden="true">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            </span>
            {{ t('overview') }} {% if metricas_gerais %}<span class="text-sm font-normal text-gray-500 ml-2">({{ t('last_plural') }} {{ metricas_gerais.periodo_dias }} {{ t('days') }})</span>{% endif %}
        </h2>
        {% if metricas_gerais %}
        <div class="gsap-scroll-reveal-stagger grid grid-cols-2 lg:grid-cols-3 gap-5">
            
            <!-- Card Total -->
            <div class="insight-card gsap-scroll-reveal-item relative overflow-hidden rounded-2xl min-h-[140px] flex flex-col cursor-default
                bg-gradient-to-br from-blue-50/80 via-white to-white border border-blue-100/60 shadow-sm hover:shadow-xl hover:shadow-blue-100/60">
                <div class="insight-shimmer rounded-2xl"></div>
                <div class="absolute top-0 left-0 right-0 h-1 rounded-t-2xl bg-gradient-to-r from-blue-400 via-blue-300 to-indigo-300"></div>
                <div class="relative z-10 p-5 flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-3">
                        <p class="text-gray-500 text-sm font-bold tracking-wide uppercase truncate mr-2 mt-1">{{ t('total_tickets') }}</p>
                        <div class="insight-icon-badge shrink-0 w-11 h-11 rounded-xl flex items-center justify-center shadow-md backdrop-blur-sm
                            bg-gradient-to-br from-blue-400 to-blue-500 text-white shadow-blue-200/50" aria-hidden="true">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-blue-500 hidden md:block"></div>
                        <p class="insight-metric-value text-3xl font-black text-gray-800 tracking-tight">{{ metricas_gerais.total_chamados }}</p>
                    </div>
                </div>
            </div>

            <!-- Card Abertos -->
            <div class="insight-card gsap-scroll-reveal-item relative overflow-hidden rounded-2xl min-h-[140px] flex flex-col cursor-default
                bg-gradient-to-br from-orange-50/80 via-white to-white border border-orange-100/60 shadow-sm hover:shadow-xl hover:shadow-orange-100/60">
                <div class="insight-shimmer rounded-2xl"></div>
                <div class="absolute top-0 left-0 right-0 h-1 rounded-t-2xl bg-gradient-to-r from-orange-400 via-orange-300 to-amber-300"></div>
                <div class="relative z-10 p-5 flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-3">
                        <p class="text-gray-500 text-sm font-bold tracking-wide uppercase truncate mr-2 mt-1">{{ t('open') }}</p>
                        <div class="insight-icon-badge shrink-0 w-11 h-11 rounded-xl flex items-center justify-center shadow-md backdrop-blur-sm
                            bg-gradient-to-br from-orange-400 to-orange-500 text-white shadow-orange-200/50" aria-hidden="true">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-orange-500 hidden md:block"></div>
                        <p class="insight-metric-value text-3xl font-black text-orange-600 tracking-tight">{{ metricas_gerais.abertos }}</p>
                    </div>
                </div>
            </div>

            <!-- Card Em Andamento -->
            <div class="insight-card gsap-scroll-reveal-item relative overflow-hidden rounded-2xl min-h-[140px] flex flex-col cursor-default
                bg-gradient-to-br from-amber-50/80 via-white to-white border border-amber-100/60 shadow-sm hover:shadow-xl hover:shadow-amber-100/60">
                <div class="insight-shimmer rounded-2xl"></div>
                <div class="absolute top-0 left-0 right-0 h-1 rounded-t-2xl bg-gradient-to-r from-amber-400 via-amber-300 to-yellow-300"></div>
                <div class="relative z-10 p-5 flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-3">
                        <p class="text-gray-500 text-sm font-bold tracking-wide uppercase truncate mr-2 mt-1">{{ t('in_progress_tickets') }}</p>
                        <div class="insight-icon-badge shrink-0 w-11 h-11 rounded-xl flex items-center justify-center shadow-md backdrop-blur-sm
                            bg-gradient-to-br from-amber-400 to-amber-500 text-white shadow-amber-200/50" aria-hidden="true">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-amber-500 hidden md:block"></div>
                        <p class="insight-metric-value text-3xl font-black text-amber-500 tracking-tight">{{ metricas_gerais.em_andamento }}</p>
                    </div>
                </div>
            </div>

            <!-- Card Concluídos -->
            <div class="insight-card gsap-scroll-reveal-item relative overflow-hidden rounded-2xl min-h-[140px] flex flex-col cursor-default
                bg-gradient-to-br from-emerald-50/80 via-white to-white border border-emerald-100/60 shadow-sm hover:shadow-xl hover:shadow-emerald-100/60">
                <div class="insight-shimmer rounded-2xl"></div>
                <div class="absolute top-0 left-0 right-0 h-1 rounded-t-2xl bg-gradient-to-r from-emerald-400 via-emerald-300 to-green-300"></div>
                <div class="relative z-10 p-5 flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-3">
                        <p class="text-gray-500 text-sm font-bold tracking-wide uppercase truncate mr-2 mt-1">{{ t('completed_tickets') }}</p>
                        <div class="insight-icon-badge shrink-0 w-11 h-11 rounded-xl flex items-center justify-center shadow-md backdrop-blur-sm
                            bg-gradient-to-br from-emerald-400 to-emerald-500 text-white shadow-emerald-200/50" aria-hidden="true">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 hidden md:block"></div>
                        <p class="insight-metric-value text-3xl font-black text-emerald-600 tracking-tight">{{ metricas_gerais.concluidos }}</p>
                    </div>
                </div>
            </div>

            <!-- Card Taxa de Resolução (Destaque Maior) -->
            <div class="insight-card gsap-scroll-reveal-item relative overflow-hidden rounded-2xl min-h-[140px] flex flex-col cursor-default
                bg-gradient-to-br from-purple-600 to-indigo-700 text-white border border-transparent shadow-lg shadow-purple-900/20 hover:shadow-2xl hover:shadow-indigo-500/30">
                <!-- Decorative orb -->
                <div class="insight-orb bg-white/10" style="width: 150px; height: 150px; bottom: -50px; left: -50px;"></div>
                <div class="insight-shimmer rounded-2xl opacity-0" style="background: linear-gradient(105deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);"></div>
                
                <div class="relative z-10 p-5 flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-3">
                        <p class="text-indigo-100 text-sm font-bold tracking-wide uppercase truncate mr-2 mt-1">{{ t('resolution_rate') }}</p>
                        <div class="insight-icon-badge shrink-0 w-11 h-11 rounded-xl flex items-center justify-center shadow-md backdrop-blur-md bg-white/20 border border-white/30" aria-hidden="true">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                    </div>
                    <p class="insight-metric-value text-4xl font-black tracking-tighter">{{ metricas_gerais.taxa_resolucao_percentual }}%</p>
                </div>
            </div>

            <!-- Card Dentro do SLA -->
            <div class="insight-card gsap-scroll-reveal-item relative overflow-hidden rounded-2xl min-h-[140px] flex flex-col cursor-default
                bg-gradient-to-br from-teal-50/80 via-white to-white border border-teal-100/60 shadow-sm hover:shadow-xl hover:shadow-teal-100/60">
                <div class="insight-shimmer rounded-2xl"></div>
                <div class="absolute top-0 left-0 right-0 h-1 rounded-t-2xl bg-gradient-to-r from-teal-400 via-teal-300 to-emerald-300"></div>
                <div class="relative z-10 p-5 flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-3">
                        <p class="text-gray-500 text-sm font-bold tracking-wide uppercase truncate mr-2 mt-1">{{ t('within_sla') }}</p>
                        <div class="insight-icon-badge shrink-0 w-11 h-11 rounded-xl flex items-center justify-center shadow-md backdrop-blur-sm
                            bg-gradient-to-br from-teal-400 to-teal-500 text-white shadow-teal-200/50" title="{{ t('sla_tooltip') }}" aria-hidden="true">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                    <div>
                        {% if metricas_gerais.percentual_dentro_sla is not none %}
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full {% if metricas_gerais.percentual_dentro_sla >= 80 %}bg-green-500{% elif metricas_gerais.percentual_dentro_sla >= 60 %}bg-teal-500{% else %}bg-amber-500{% endif %} hidden md:block"></div>
                            <p class="insight-metric-value text-3xl font-black tracking-tight {% if metricas_gerais.percentual_dentro_sla >= 80 %}text-green-600{% elif metricas_gerais.percentual_dentro_sla >= 60 %}text-teal-600{% else %}text-amber-600{% endif %}">{{ metricas_gerais.percentual_dentro_sla }}%</p>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 line-clamp-1" title="{{ t('sla_tooltip') }}">{{ t('sla_tooltip') }}</p>
                        {% else %}
                        <p class="text-2xl font-bold text-gray-400">—</p>
                        <p class="text-xs text-gray-400 mt-1 line-clamp-1">{{ t('none_completed_period') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <p class="text-gray-500 text-sm py-6 text-center bg-gray-50/50 rounded-xl border border-gray-100">
            {{ t('no_data_available') }}
        </p>
        {% endif %}
    </div>

    <!-- Gráficos em linha -->
    <div class="gsap-scroll-reveal grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <!-- Gráfico: Distribuição de Chamados por Status -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
            <h3 class="text-base font-bold text-gray-800 mb-4">{{ t('distribution_by_status') }}</h3>
            <div class="chart-container flex-1" style="position: relative; min-height: 250px; width: 100%;">
                <canvas id="chartStatus"></canvas>
            </div>
        </div>

        <!-- Gráfico: Prioridade -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
            <h3 class="text-base font-bold text-gray-800 mb-4">{{ t('distribution_by_priority') }}</h3>
            <div class="chart-container flex-1" style="position: relative; min-height: 250px; width: 100%;">
                <canvas id="chartPrioridade"></canvas>
            </div>
        </div>
    </div>

    <!-- RESUMO SLA -->
    {% if metricas_gerais and metricas_gerais.get('resumo_sla') %}
    <div class="gsap-scroll-reveal mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="bg-teal-100 text-teal-600 p-1.5 rounded-lg mr-2" aria-hidden="true">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </span>
            {{ t('sla_summary') }}
        </h2>
        <p class="text-sm text-gray-500 mb-4">({{ t('last_plural') }} {{ metricas_gerais.periodo_dias }} {{ t('days') }} · {{ t('sla_tooltip') }})</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="gsap-scroll-reveal-item bg-white p-5 min-h-[100px] rounded-2xl shadow-sm hover:shadow border border-gray-100 transition flex flex-col justify-center">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">{{ t('on_time') }}</p>
                <p class="text-3xl font-black text-green-600">{{ metricas_gerais.resumo_sla.no_prazo }}</p>
                <p class="text-xs text-gray-400 mt-1">{{ t('completed_on_time') }}</p>
            </div>
            <div class="gsap-scroll-reveal-item bg-white p-5 min-h-[100px] rounded-2xl shadow-sm hover:shadow border border-gray-100 transition flex flex-col justify-center">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">{{ t('delayed') }}</p>
                <p class="text-3xl font-black text-red-600">{{ metricas_gerais.resumo_sla.atrasado }}</p>
                <p class="text-xs text-gray-400 mt-1">{{ t('overdue') }}</p>
            </div>
            <div class="gsap-scroll-reveal-item bg-white p-5 min-h-[100px] rounded-2xl shadow-sm hover:shadow border border-amber-200 transition flex flex-col justify-center bg-amber-50/50">
                <p class="text-xs text-amber-700 uppercase tracking-wider mb-1 font-semibold">{{ t('at_risk') }}</p>
                <p class="text-3xl font-black text-amber-600">{{ metricas_gerais.resumo_sla.em_risco }}</p>
                <p class="text-xs text-gray-500 mt-1">{{ t('due_in_1_day') }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- DESEMPENHO POR SUPERVISOR -->
    {% if metricas_supervisores %}
    <div class="gsap-scroll-reveal mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg mr-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            </span>
            {{ t('team_performance') }}
        </h2>
        
        <!-- Tabelas e Gráficos de Perf -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            
            <!-- Tabela de Supervisores -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden xl:col-span-3 min-w-0">
                <table class="w-full min-w-0 table-fixed text-left text-sm">
                    <thead class="bg-gray-50/50 border-b border-gray-100 uppercase text-xs font-bold tracking-wider text-gray-500">
                        <tr>
                            <th class="w-[18%] px-2 py-2">{{ t('supervisor') }}</th>
                            <th class="w-[14%] px-2 py-2">{{ t('area_th') }}</th>
                            <th class="w-[8%] px-2 py-2 text-center">{{ t('total') }}</th>
                            <th class="w-[8%] px-2 py-2 text-center">{{ t('workload') }}</th>
                            <th class="w-[8%] px-2 py-2 text-center">{{ t('completed_short') }}</th>
                            <th class="w-[14%] px-2 py-2">{{ t('rate') }}</th>
                            <th class="w-[12%] px-2 py-2 text-right">{{ t('time') }}</th>
                            <th class="w-[10%] px-2 py-2 text-right">{{ t('sla_percent') }}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for sup in metricas_supervisores %}
                        <tr class="hover:bg-blue-50/30 transition group">
                            <td class="px-2 py-2">
                                <div class="flex items-center min-w-0">
                                    <div class="w-7 h-7 rounded-full bg-blue-100 text-blue-600 font-bold flex items-center justify-center mr-2 text-xs shrink-0">
                                        {{ sup.supervisor_nome[0] }}
                                    </div>
                                    <div class="min-w-0">
                                        <div class="font-bold text-gray-800 truncate" title="{{ sup.supervisor_nome }}">{{ nome_curto(sup.supervisor_nome) }}</div>
                                        <div class="text-xs text-gray-400 truncate" title="{{ sup.supervisor_email }}">{{ sup.supervisor_email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-2 py-2 text-gray-600 truncate" title="{{ sup.area }}">{{ sup.area.split(', ')|map('translate_sector')|join(', ') if ', ' in sup.area else translate_sector(sup.area) }}</td>
                            <td class="px-2 py-2 text-center">
                                <span class="inline-flex justify-center font-bold text-gray-700 bg-gray-100 px-1.5 py-0.5 rounded text-xs">{{ sup.total_chamados }}</span>
                            </td>
                            <td class="px-2 py-2 text-center">
                                <span class="inline-flex justify-center font-bold text-xs shadow-sm 
                                    {% if sup.carga_atual > 10 %}
                                        bg-red-500 text-white
                                    {% elif sup.carga_atual > 5 %}
                                        bg-yellow-400 text-yellow-900
                                    {% else %}
                                        bg-emerald-100 text-emerald-800
                                    {% endif %}
                                    px-1.5 py-0.5 rounded">
                                    {{ sup.carga_atual }}
                                </span>
                            </td>
                            <td class="px-2 py-2 text-center font-bold text-emerald-600 text-xs">{{ sup.concluidos }}</td>
                            <td class="px-2 py-2">
                                <div class="flex items-center gap-1.5">
                                    <div class="flex-1 min-w-0 bg-gray-100 rounded-full h-1.5">
                                        <div class="bg-indigo-500 h-1.5 rounded-full" data-width="{{ sup.taxa_resolucao_percentual }}"></div>
                                    </div>
                                    <span class="text-xs font-bold text-gray-700 shrink-0 w-8 text-right">{{ sup.taxa_resolucao_percentual }}%</span>
                                </div>
                            </td>
                            <td class="px-2 py-2 text-right font-mono text-gray-500 text-xs">{{ sup.tempo_medio_resolucao_horas }}h</td>
                            <td class="px-2 py-2 text-right">
                                {% if sup.percentual_dentro_sla is not none %}
                                <span class="font-bold text-xs {% if sup.percentual_dentro_sla >= 80 %}text-green-600{% elif sup.percentual_dentro_sla >= 60 %}text-teal-600{% else %}text-amber-600{% endif %}">{{ sup.percentual_dentro_sla }}%</span>
                                {% else %}
                                <span class="text-gray-400 text-xs">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Gráfico de Carga -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col xl:col-span-1">
                <h3 class="text-sm font-bold text-gray-800 mb-4 whitespace-nowrap">{{ t('workload_distributed') }}</h3>
                <div class="chart-container flex-1" style="position: relative; min-height: 200px; width: 100%;">
                    <canvas id="chartCarga"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- DESEMPENHO POR ÁREA -->
    {% if metricas_areas %}
    <div class="gsap-scroll-reveal mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <span class="bg-pink-100 text-pink-600 p-1.5 rounded-lg mr-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            </span>
            {{ t('area_performance') }}
        </h2>
        
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- Tabela de Áreas -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden xl:col-span-3 min-w-0">
                <table class="w-full min-w-0 table-fixed text-left text-sm">
                    <thead class="bg-gray-50/50 border-b border-gray-100 uppercase text-xs font-bold tracking-wider text-gray-500">
                        <tr>
                            <th class="w-[18%] px-2 py-2">{{ t('area_th') }}</th>
                            <th class="w-[8%] px-2 py-2 text-center">{{ t('total') }}</th>
                            <th class="w-[8%] px-2 py-2 text-center">{{ t('open') }}</th>
                            <th class="w-[8%] px-2 py-2 text-center">{{ t('completed_short') }}</th>
                            <th class="w-[14%] px-2 py-2">{{ t('rate') }}</th>
                            <th class="w-[10%] px-2 py-2 text-right">{{ t('time') }}</th>
                            <th class="w-[10%] px-2 py-2 text-center">{{ t('sups_short') }}</th>
                            <th class="w-[14%] px-2 py-2 text-right">{{ t('balanced') }}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for area in metricas_areas %}
                        <tr class="hover:bg-pink-50/20 transition group">
                            <td class="px-2 py-2 font-bold text-gray-800">
                                <div class="flex items-center min-w-0">
                                    <div class="w-1.5 h-1.5 rounded-full bg-pink-400 mr-1.5 shrink-0"></div>
                                    <span class="truncate" title="{{ area.area }}">{{ translate_sector(area.area) }}</span>
                                </div>
                            </td>
                            <td class="px-2 py-2 text-center">
                                <span class="inline-flex justify-center font-bold text-gray-700 bg-gray-100 px-1.5 py-0.5 rounded text-xs">{{ area.total_chamados }}</span>
                            </td>
                            <td class="px-2 py-2 text-center text-xs text-orange-600 font-bold">{{ area.abertos }}</td>
                            <td class="px-2 py-2 text-center text-xs text-emerald-600 font-bold">{{ area.concluidos }}</td>
                            <td class="px-2 py-2">
                                <div class="flex items-center gap-1.5">
                                    <div class="flex-1 min-w-0 bg-gray-100 rounded-full h-1.5">
                                        <div class="bg-pink-500 h-1.5 rounded-full" data-width="{{ area.taxa_resolucao_percentual }}"></div>
                                    </div>
                                    <span class="text-xs font-bold text-gray-700 shrink-0 w-8 text-right">{{ area.taxa_resolucao_percentual }}%</span>
                                </div>
                            </td>
                            <td class="px-2 py-2 text-right font-mono text-gray-500 text-xs">{{ area.tempo_medio_resolucao_horas }}h</td>
                            <td class="px-2 py-2 text-center text-xs font-semibold text-gray-500">{{ area.supervisores_alocados }}</td>
                            <td class="px-2 py-2 text-right">
                                <span class="font-bold text-teal-800 bg-teal-100 px-1.5 py-0.5 rounded border border-teal-200 text-xs">
                                    {{ area.taxa_automacao_percentual }}%
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Gráfico de Taxa por Área -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col xl:col-span-1">
                <h3 class="text-sm font-bold text-gray-800 mb-4 whitespace-nowrap">{{ t('resolution_rate_by_area') }}</h3>
                <div class="chart-container flex-1" style="position: relative; min-height: 200px; width: 100%;">
                    <canvas id="chartAreas"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Dados JSON para os gráficos -->
<script type="application/json" id="dados-gerais">{{ metricas_gerais|tojson|safe }}</script>
<script type="application/json" id="dados-supervisores">{{ metricas_supervisores|tojson|safe }}</script>
<script type="application/json" id="dados-areas">{{ metricas_areas|tojson|safe }}</script>

<script>
// Aguardar carregar completo da página
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar loading
    const loadingEl = document.getElementById('loading-charts');
    if (loadingEl) loadingEl.style.display = 'flex';

    // Carregar dados dos gráficos (com fallback para dados vazios/ausentes)
    function parseJson(id, fallback) {
        var el = document.getElementById(id);
        if (!el || !el.textContent || el.textContent.trim() === '') return fallback;
        try {
            var v = JSON.parse(el.textContent);
            return v != null ? v : fallback;
        } catch (e) { return fallback; }
    }
    const dadosGerais = parseJson('dados-gerais', {});
    const dadosSupervisores = Array.isArray(parseJson('dados-supervisores', null)) ? parseJson('dados-supervisores', []) : [];
    const dadosAreas = Array.isArray(parseJson('dados-areas', null)) ? parseJson('dados-areas', []) : [];

    // Gráfico: Distribuição por Status
    if (document.getElementById('chartStatus')) {
        const ctxStatus = document.getElementById('chartStatus').getContext('2d');
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['{{ t("open") }}', '{{ t("in_progress_tickets") }}', '{{ t("completed_tickets") }}'],
                datasets: [{
                    data: [
                        dadosGerais.abertos || 0,
                        dadosGerais.em_andamento || 0,
                        dadosGerais.concluidos || 0
                    ],
                    backgroundColor: [
                        '#FFA500',
                        '#FFD700',
                        '#4CAF50'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Gráfico: Prioridade (Projetos = 0, demais = Não Aplicável)
    if (document.getElementById('chartPrioridade') && dadosGerais.distribuicao_prioridade) {
        const ctxPrio = document.getElementById('chartPrioridade').getContext('2d');
        const dp = dadosGerais.distribuicao_prioridade;
        const countProjetos = (dp[0] ?? dp['0'] ?? 0);
        let countNaoAplicavel = 0;
        Object.keys(dp).forEach(function(k) {
            if (k !== '0' && k !== 0) countNaoAplicavel += (Number(dp[k]) || 0);
        });
        const labels = ['{{ t("projects") }}', '{{ t("not_applicable") }}'];
        const data = [countProjetos, countNaoAplicavel];

        new Chart(ctxPrio, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '{{ t("total_tickets") }}',
                    data: data,
                    backgroundColor: '#3B82F6',
                    borderColor: '#1F2937',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Gráfico: Carga de Trabalho
    if (document.getElementById('chartCarga') && dadosSupervisores.length > 0) {
        const ctxCarga = document.getElementById('chartCarga').getContext('2d');
        const top3 = dadosSupervisores.slice().sort(function(a, b) { return b.carga_atual - a.carga_atual; }).slice(0, 3);
        const nomes = top3.map(s => s.supervisor_nome.split(' ')[0]);
        const cargas = top3.map(s => s.carga_atual);
        
        new Chart(ctxCarga, {
            type: 'bar',
            data: {
                labels: nomes,
                datasets: [{
                    label: '{{ t("open") }} + {{ t("in_progress_tickets") }}',
                    data: cargas,
                    backgroundColor: cargas.map(c => c > 10 ? '#EF4444' : c > 5 ? '#FBBF24' : '#10B981'),
                    borderColor: '#1F2937',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Gráfico: Taxa por Área
    if (document.getElementById('chartAreas') && dadosAreas.length > 0) {
        const ctxArea = document.getElementById('chartAreas').getContext('2d');
        const sectorTranslations = JSON.parse('{{ {"Manutencao": t("maintenance"), "Engenharia": t("engineering"), "Qualidade": t("quality"), "Comercial": t("commercial"), "Planejamento": t("planning"), "Material": t("indirect_material")}|tojson|safe }}');
        function trSector(name) { return sectorTranslations[name] || name; }
        const areasNomes = dadosAreas.map(a => trSector(a.area));
        const taxas = dadosAreas.map(a => a.taxa_resolucao_percentual);
        
        new Chart(ctxArea, {
            type: 'bar',
            data: {
                labels: areasNomes,
                datasets: [{
                    label: '{{ t("resolution_rate") }} (%)',
                    data: taxas,
                    backgroundColor: taxas.map(t => t > 60 ? '#10B981' : t > 40 ? '#FBBF24' : '#EF4444'),
                    borderColor: '#1F2937',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    y: { 
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Aplicar larguras das barras de progresso
    document.querySelectorAll('[data-width]').forEach(function(el) {
        el.style.width = el.getAttribute('data-width') + '%';
    });

    // Esconder loading após renderizar
    setTimeout(function() {
        if (loadingEl) loadingEl.style.display = 'none';
    }, 100);
});
</script>

{% endblock %}
