{% extends "base.html" %}

{% block content %}
<div class="space-y-6">

    <!-- Header com Info do Usuário -->
    <div
        class="flex flex-col md:flex-row justify-between items-center bg-gray-50/50 p-6 rounded-2xl border border-gray-100 gap-4 mb-2">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-xl hidden sm:block">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </div>
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight">{{ t('dashboard_title') }}</h2>
                <div class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                    <span class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">{{ total_chamados }}</span> 
                    <span>{{ t('found_tickets') }} ({{ t('page') }} {{ pagina_atual }} {{ t('of') }} {{ total_paginas }})</span>
                    {% if current_user.is_authenticated %}
                    <span class="text-gray-300">|</span>
                    <span class="inline-flex items-center text-gray-600 font-medium bg-gray-100 px-2 py-0.5 rounded-full text-xs">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        {{ current_user.nome }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto flex-col md:flex-row justify-end">
            <a href="{{ url_for('main.exportar', **request.args) }}"
                class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 font-semibold rounded-xl transition justify-center text-sm shadow-sm group">
                <svg class="w-5 h-5 mr-2 text-green-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                {{ t('export') }}
            </a>
            {% if current_user.is_authenticated and current_user.perfil in ['admin', 'supervisor'] %}
            <a href="{{ url_for('main.exportar_avancado', **request.args) }}"
                class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 font-semibold rounded-xl transition justify-center text-sm shadow-sm group"
                title="Exportar relatório profissional com múltiplas abas">
                <svg class="w-5 h-5 mr-2 text-emerald-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                {{ t('reports') }}
            </a>
            {% endif %}

            {% if current_user.is_authenticated %}
            <a href="{{ url_for('main.logout') }}"
                class="inline-flex items-center px-3 py-2 text-gray-400 hover:text-red-600 hover:bg-red-50 font-medium rounded-xl transition justify-center text-sm ml-1" title="{{ t('logout') }}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Dicionário de Tradução para JavaScript -->
    <script>
        // Mapeamento de setores para chaves de tradução
        const sectorMap = {
            'Manutencao': '{{ t("maintenance") }}',
            'Engenharia': '{{ t("engineering") }}',
            'Qualidade': '{{ t("quality") }}',
            'Comercial': '{{ t("commercial") }}',
            'Planejamento': '{{ t("planning") }}',
            'Material': '{{ t("indirect_material") }}'
        };

        // Mapeamento de categorias para chaves de tradução
        const categoryMap = {
            'Projetos': '{{ t("projects") }}',
            'Nao Aplicavel': '{{ t("not_applicable") }}'
        };

        // Mapeamento de status para chaves de tradução
        const statusMap = {
            'Aberto': '{{ t("option_open") }}',
            'Em Atendimento': '{{ t("option_in_progress") }}',
            'Concluído': '{{ t("option_completed") }}'
        };

        // Função auxiliar para  traduzir setores e categorias
        function translateSector(sectorName) {
            return sectorMap[sectorName] || sectorName;
        }

        function translateCategory(categoryName) {
            return categoryMap[categoryName] || categoryName;
        }

        function translateStatus(statusName) {
            return statusMap[statusName] || statusName;
        }

        // ========================================
        // Animação modesta de status e loading
        // ========================================
    </script>

    <form method="GET" action="{{ url_for('main.admin') }}" class="space-y-4">
        <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm relative overflow-hidden">
            <!-- Detalhe decorativo -->
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-indigo-500 rounded-l-2xl"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-5 items-end pl-2">

                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('search') }}</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </span>
                        <input type="text" name="search" value="{{ request.args.get('search', '') }}"
                            placeholder="{{ t('search_placeholder') }}"
                            class="pl-9 block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors">
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('category') }}</label>
                    <select name="categoria"
                        class="block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors px-3">
                        <option value="">{{ t('all') }}</option>
                        <option value="Projetos" {% if request.args.get('categoria')=='Projetos' %}selected{% endif %}>
                            {{ t('projects') }}</option>
                        <option value="Nao Aplicavel" {% if request.args.get('categoria')=='Nao Aplicavel' %}selected{%
                            endif %}>{{ t('not_applicable') }}</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('status') }}</label>
                    <select name="status"
                        class="block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors px-3">
                        <option value="">{{ t('all') }}</option>
                        <option value="Aberto" {% if request.args.get('status')=='Aberto' %}selected{% endif %}>{{ t('open') }}</option>
                        <option value="Em Atendimento" {% if request.args.get('status')=='Em Atendimento' %}selected{% endif %}>{{ t('in_progress') }}</option>
                        <option value="Concluído" {% if request.args.get('status')=='Concluído' %}selected{% endif %}>{{ t('completed') }}</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('assigned_to') }}</label>
                    <select name="responsavel"
                        class="block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors px-3">
                        <option value="">{{ t('all') }}</option>
                        {% for nome in lista_responsaveis %}
                        <option value="{{ nome }}" {% if request.args.get('responsavel')==nome %}selected{% endif %}>{{ nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="md:col-span-3 flex space-x-2">
                    <button type="submit"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl shadow-sm h-11 transition-colors flex items-center justify-center gap-2">
                        <span>{{ t('filter') }}</span>
                    </button>
                    <a href="{{ url_for('main.admin') }}"
                        class="bg-gray-50 hover:bg-gray-200 text-gray-500 hover:text-gray-700 font-bold w-11 rounded-xl h-11 flex items-center justify-center transition-colors"
                        title="{{ t('clear_filters') }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </a>
                </div>
            </div>
        </div>


    </form>

    <div id="bulk-bar"
        class="hidden mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg flex flex-wrap items-center gap-3">
        <span class="text-sm font-medium text-blue-900">{{ t('bulk_change_status') }}:</span>
        <select id="bulk-status"
            class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 border px-2 py-1">
            <option value="Aberto">{{ t('open') }}</option>
            <option value="Em Atendimento">{{ t('in_progress') }}</option>
            <option value="Concluído">{{ t('completed') }}</option>
        </select>
        <button type="button" id="bulk-apply"
            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition">{{
            t('apply') }}</button>
        <span id="bulk-count" class="text-sm text-blue-700"></span>
    </div>

    <div class="bg-white shadow-sm rounded-2xl overflow-hidden border border-gray-100 p-1">
        <table class="min-w-full divide-y divide-gray-100">
            <thead class="bg-gray-50/50">
                <tr>
                    <th class="px-5 py-4 text-left">
                        <input type="checkbox" id="bulk-select-all"
                            class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                            title="{{ t('select_all') }}">
                    </th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('id_ref') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('category') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('sector_gate') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('assigned_to') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('description') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('status') }}</th>
                    <th class="px-5 py-4 text-center text-xs font-bold text-gray-400 uppercase tracking-widest">SLA</th>
                    <th class="px-5 py-4 text-center text-xs font-bold text-gray-400 uppercase tracking-widest min-w-[7rem]">{{ t('actions') }}</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-50/80 gsap-stagger-container">
                {% if chamados %}
                {% for chamado in chamados %}
                <tr data-chamado-id="{{ chamado.id }}"
                    class="gsap-stagger hover:bg-indigo-50/50 transition duration-150 group cursor-default {% if chamado.categoria == 'Projetos' %}bg-red-50/20{% endif %}">
                    <td class="px-5 py-4 whitespace-nowrap">
                        <input type="checkbox" class="bulk-cb rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                            value="{{ chamado.id }}" data-id="{{ chamado.id }}">
                    </td>
                    <td class="px-5 py-4 whitespace-nowrap" data-cell="numero">
                        <div class="text-sm font-black text-gray-800">{{ chamado.numero_chamado }}</div>
                        {% if chamado.rl_codigo %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-pink-100 text-pink-700 mt-1 uppercase tracking-wider">
                            {{ t('rl_short') }} {{ chamado.rl_codigo }}
                        </span>
                        {% endif %}
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap" data-cell="categoria">
                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-bold rounded-lg 
                                {% if chamado.categoria == 'Projetos' %}bg-pink-100 text-pink-700{% else %}bg-indigo-100 text-indigo-700{% endif %}">
                            {{ translate_category(chamado.categoria) }}
                        </span>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap" data-cell="setor">
                        <div class="text-sm font-semibold text-gray-800">{{ translate_sector(chamado.tipo_solicitacao) }}</div>
                        <div class="text-xs font-medium text-gray-400">{{ chamado.gate }}</div>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap" data-cell="responsavel">
                        <div class="flex items-center">
                            {% if chamado.responsavel %}
                            <div class="h-6 w-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold mr-2">
                                {{ chamado.responsavel[0] }}
                            </div>
                            {% endif %}
                            <span class="text-sm font-medium text-gray-700">{{ nome_curto(chamado.responsavel) or '—' }}</span>
                        </div>
                    </td>

                    <td class="px-5 py-4" data-cell="descricao">
                        <div class="text-sm text-gray-700 truncate max-w-[120px] cursor-pointer group-hover:text-indigo-600 font-medium"
                            title="{{ t('click_eye_full') }}">
                            {{ chamado.descricao[:15] }}{% if chamado.descricao|length > 15 %}...{% endif %}
                        </div>
                        <div class="text-xs text-gray-400 font-medium mt-0.5">
                            {{ chamado.data_abertura_formatada() }}
                        </div>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap" data-cell="status">
                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-bold rounded-lg 
                                {% if chamado.status == 'Concluído' %}bg-emerald-100 text-emerald-700{% elif chamado.status == 'Em Atendimento' %}bg-amber-100 text-amber-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                            <span class="w-1.5 h-1.5 rounded-full mr-1.5 mt-1.5 {% if chamado.status == 'Concluído' %}bg-emerald-500{% elif chamado.status == 'Em Atendimento' %}bg-amber-500{% else %}bg-blue-500{% endif %}"></span>
                            {{ translate_status(chamado.status or 'Aberto') }}
                        </span>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap text-center" data-cell="sla">
                        {% if chamado.sla_info %}
                        <span class="px-2 py-1 inline-flex text-xs font-bold rounded-lg
                                {% if chamado.sla_info.dentro_prazo %}bg-emerald-100 text-emerald-700
                                {% elif chamado.sla_info.em_risco %}bg-amber-100 text-amber-700
                                {% else %}bg-red-100 text-red-700{% endif %}"
                                title="{{ t('sla_tooltip') }}">
                            {% if chamado.sla_info.label == 'No prazo' %}{{ t('on_time') }}{% elif chamado.sla_info.label == 'Atrasado' %}{{ t('delayed') }}{% elif chamado.sla_info.label == 'Em risco' %}{{ t('at_risk') }}{% else %}{{ chamado.sla_info.label }}{% endif %}
                        </span>
                        {% else %}
                        <span class="text-gray-300 text-xs">—</span>
                        {% endif %}
                    </td>

                    <td class="px-5 py-4 text-sm font-medium flex items-center justify-center space-x-2 min-w-[7rem] shrink-0">
                        <a href="{{ url_for('main.visualizar_detalhe_chamado', chamado_id=chamado.id) }}" target="_blank" rel="opener"
                            class="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="{{ t('view_details') }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </a>

                        <a href="{{ url_for('main.visualizar_historico', chamado_id=chamado.id) }}"
                            class="p-1.5 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                            title="{{ t('view_history') }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="9" class="px-6 py-10 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="w-12 h-12 text-gray-300 mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            <p class="text-lg font-medium">{{ t('no_tickets') }}</p>
                            <p class="text-sm">{{ t('no_tickets_hint') }}</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Paginação -->
    {% if total_paginas > 1 %}
    <div
        class="flex flex-col md:flex-row justify-between items-center bg-gray-50/50 p-4 rounded-2xl border border-gray-100 gap-4 mt-6">
        <div class="text-sm text-gray-500 font-medium">
            {{ t('showing') }} <span class="font-bold text-gray-800">{{ (pagina_atual - 1) * itens_por_pagina + 1 }}</span> {{
            t('to') }}
            <span class="font-bold text-gray-800">{{ [pagina_atual * itens_por_pagina, total_chamados]|min }}</span>
            {{ t('of') }} <span class="font-bold text-gray-800">{{ total_chamados }}</span> {{ t('found_tickets') }}
        </div>

        <div class="flex items-center gap-1 bg-white border border-gray-200 rounded-xl p-1 shadow-sm">
            {% if pagina_atual > 1 %}
            <a href="{{ url_for('main.admin', pagina=1, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('first') }}">
                «
            </a>
            <a href="{{ url_for('main.admin', pagina=pagina_atual-1, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('previous') }}">
                ‹
            </a>
            {% endif %}

            <!-- Números das Páginas -->
            {% for p in range(max(1, pagina_atual - 2), min(total_paginas + 1, pagina_atual + 3)) %}
            {% if p == pagina_atual %}
            <button disabled
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-bold text-white bg-indigo-600 shadow-sm">
                {{ p }}
            </button>
            {% else %}
            <a href="{{ url_for('main.admin', pagina=p, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors">
                {{ p }}
            </a>
            {% endif %}
            {% endfor %}

            {% if pagina_atual < total_paginas %} <a
                href="{{ url_for('main.admin', pagina=pagina_atual+1, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('next') }}">
                ›
                </a>
                <a href="{{ url_for('main.admin', pagina=total_paginas, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                    class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('last') }}">
                    »
                </a>
                {% endif %}
        </div>
    </div>
    {% endif %}

{% endblock %}

{% block page_scripts %}
    <!-- As funções abrirModal e fecharModal já estão definidas inline acima -->
    <script src="{{ url_for('static', filename='js/dashboard_otimizacoes.js') }}?v=4"></script>
    
    <script>
        // Interceptar submit do formulário de status no modal para enviar via AJAX
        (function () {
            var formStatus = document.getElementById('form-status-modal');
            if (formStatus) {
                formStatus.addEventListener('submit', function (e) {
                    e.preventDefault();

                    // Coleta os dados do formulário
                    var formData = new FormData(formStatus);
                    // Anexar textarea caso esteja fora do form (na nossa estrutura atual, ele estaria fora se não movermos)
                    var textareaDesc = document.getElementById('modal-descricao');
                    if (textareaDesc) {
                        formData.set('nova_descricao', textareaDesc.value);
                    }
                    var inputFile = document.getElementById('modal-input-anexo');
                    if (inputFile && inputFile.files.length > 0) {
                        formData.set('anexo', inputFile.files[0]);
                    }

                    var btnSubmit = document.getElementById('btn-submit-status');

                    // Desabilita botão
                    if (btnSubmit) {
                        btnSubmit.disabled = true;
                        btnSubmit.innerText = '{{ t("saving") }}';
                    }

                    // Envia via AJAX para a API (CSRF no header)
                    var csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    var headers = {};
                    if (csrfMeta && csrfMeta.content) headers['X-CSRFToken'] = csrfMeta.content;
                    fetch('/api/editar-chamado', {
                        method: 'POST',
                        headers: headers,
                        body: formData
                    })
                        .then(function (response) {
                            return response.json();
                        })
                        .then(function (data) {
                            if (data.sucesso) {
                                window.location.reload();
                            } else {
                                alert('Erro: ' + (data.erro || 'Desconhecido'));
                                if (btnSubmit) { btnSubmit.disabled = false; btnSubmit.innerText = 'Salvar Alteração'; }
                            }
                        })
                        .catch(function (error) {
                            console.error('❌ Erro ao editar chamado:', error);
                            alert('{{ t("save_error") }}');
                            if (btnSubmit) { btnSubmit.disabled = false; btnSubmit.innerText = '{{ t("save_change") }}'; }
                        });
                });
            }
        })();


        (function () {
            var bulkBar = document.getElementById('bulk-bar');
            var bulkSelectAll = document.getElementById('bulk-select-all');
            var bulkStatus = document.getElementById('bulk-status');
            var bulkApply = document.getElementById('bulk-apply');
            var bulkCount = document.getElementById('bulk-count');
            function updateBulkBar() {
                var cbs = document.querySelectorAll('.bulk-cb:checked');
                var n = cbs.length;
                if (n > 0) {
                    bulkBar.classList.remove('hidden');
                    bulkCount.textContent = n + ' selecionado(s)';
                } else {
                    bulkBar.classList.add('hidden');
                    if (bulkSelectAll) bulkSelectAll.checked = false;
                }
            }
            if (bulkSelectAll) {
                bulkSelectAll.addEventListener('change', function () {
                    document.querySelectorAll('.bulk-cb').forEach(function (cb) { cb.checked = bulkSelectAll.checked; });
                    updateBulkBar();
                });
            }
            document.querySelectorAll('.bulk-cb').forEach(function (cb) {
                cb.addEventListener('change', updateBulkBar);
            });
            if (bulkApply) {
                bulkApply.addEventListener('click', function () {
                    var ids = [];
                    document.querySelectorAll('.bulk-cb:checked').forEach(function (cb) { ids.push(cb.value); });
                    if (ids.length === 0) return;
                    var status = bulkStatus ? bulkStatus.value : 'Concluído';
                    bulkApply.disabled = true;
                    var csrfInput = document.querySelector('input[name="csrf_token"]');
                    var csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    var headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
                    if (csrfInput) headers['X-CSRFToken'] = csrfInput.value;
                    else if (csrfMeta && csrfMeta.content) headers['X-CSRFToken'] = csrfMeta.content;
                    fetch('{{ url_for("main.bulk_atualizar_status") }}', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ chamado_ids: ids, novo_status: status })
                    }).then(function (r) { return r.json(); }).then(function (data) {
                        if (data.sucesso) {
                            window.location.reload();
                        } else {
                            alert(data.erro || 'Erro ao atualizar');
                            bulkApply.disabled = false;
                        }
                    }).catch(function () {
                        alert('Erro de rede');
                        bulkApply.disabled = false;
                    });
                });
            }
        })();

        // Atualizar apenas a linha do chamado quando a aba de detalhes for fechada (postMessage da aba filha)
        (function () {
            function nomeCurto(nome) {
                if (!nome || !nome.trim()) return '—';
                var p = nome.trim().split(/\s+/);
                if (p.length >= 2) return p[0] + ' ' + p[p.length - 1].charAt(0) + '.';
                return nome.length > 25 ? nome.slice(0, 25) + '...' : nome;
            }
            function updateRowFromChamado(chamadoId, c) {
                var row = document.querySelector('tr[data-chamado-id="' + chamadoId + '"]');
                if (!row) return;
                var cat = typeof translateCategory === 'function' ? translateCategory(c.categoria) : (categoryMap && categoryMap[c.categoria]) || c.categoria;
                var set = function (cell, html) {
                    var el = row.querySelector('[data-cell="' + cell + '"]');
                    if (el) el.innerHTML = html;
                };
                set('numero', '<div class="text-sm font-black text-gray-800">' + (c.numero_chamado || '') + '</div>' +
                    (c.rl_codigo ? '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-pink-100 text-pink-700 mt-1 uppercase tracking-wider">{{ t("rl_short") }} ' + (c.rl_codigo || '') + '</span>' : ''));
                set('categoria', '<span class="px-2.5 py-1 inline-flex text-xs leading-5 font-bold rounded-lg ' + (c.categoria === 'Projetos' ? 'bg-pink-100 text-pink-700' : 'bg-indigo-100 text-indigo-700') + '">' + cat + '</span>');
                var setor = typeof translateSector === 'function' ? translateSector(c.tipo_solicitacao) : (sectorMap && sectorMap[c.tipo_solicitacao]) || c.tipo_solicitacao || '';
                set('setor', '<div class="text-sm font-semibold text-gray-800">' + setor + '</div><div class="text-xs font-medium text-gray-400">' + (c.gate || '') + '</div>');
                set('responsavel', '<div class="flex items-center">' + (c.responsavel ? '<div class="h-6 w-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold mr-2">' + (c.responsavel.charAt(0) || '') + '</div>' : '') + '<span class="text-sm font-medium text-gray-700">' + nomeCurto(c.responsavel) + '</span></div>');
                var desc = (c.descricao || '').slice(0, 15) + ((c.descricao || '').length > 15 ? '...' : '');
                set('descricao', '<div class="text-sm text-gray-700 truncate max-w-[120px] cursor-pointer group-hover:text-indigo-600 font-medium" title="{{ t("click_eye_full") }}">' + desc + '</div><div class="text-xs text-gray-400 font-medium mt-0.5">' + (c.data_abertura || '-') + '</div>');
                var statusLabel = typeof translateStatus === 'function' ? translateStatus(c.status || 'Aberto') : (statusMap && statusMap[c.status]) || c.status || 'Aberto';
                var statusCls = (c.status === 'Concluído') ? 'bg-emerald-100 text-emerald-700' : (c.status === 'Em Atendimento') ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700';
                var statusDot = (c.status === 'Concluído') ? 'bg-emerald-500' : (c.status === 'Em Atendimento') ? 'bg-amber-500' : 'bg-blue-500';
                set('status', '<span class="px-2.5 py-1 inline-flex text-xs leading-5 font-bold rounded-lg ' + statusCls + '"><span class="w-1.5 h-1.5 rounded-full mr-1.5 mt-1.5 ' + statusDot + '"></span>' + statusLabel + '</span>');
                var sla = c.sla_info;
                var slaHtml = !sla ? '<span class="text-gray-300 text-xs">—</span>' : '<span class="px-2 py-1 inline-flex text-xs font-bold rounded-lg ' + (sla.dentro_prazo ? 'bg-emerald-100 text-emerald-700' : sla.em_risco ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700') + '" title="{{ t("sla_tooltip") }}">' + (sla.label === 'No prazo' ? '{{ t("on_time") }}' : sla.label === 'Atrasado' ? '{{ t("delayed") }}' : sla.label === 'Em risco' ? '{{ t("at_risk") }}' : sla.label) + '</span>';
                set('sla', slaHtml);
            }
            window.addEventListener('message', function (event) {
                if (event.data && event.data.type === 'refreshChamado' && event.data.chamadoId) {
                    var chamadoId = event.data.chamadoId;
                    fetch('/api/chamado/' + encodeURIComponent(chamadoId))
                        .then(function (r) { return r.json(); })
                        .then(function (res) {
                            if (res.sucesso && res.chamado) updateRowFromChamado(chamadoId, res.chamado);
                        })
                        .catch(function () {});
                }
            });
        })();
    </script>

    {% endblock %}