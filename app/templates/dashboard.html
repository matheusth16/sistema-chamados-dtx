{% extends "base.html" %}

{% block content %}
<div class="space-y-6">

    <!-- Header com Info do UsuÃ¡rio -->
    <div
        class="flex flex-col md:flex-row justify-between items-center bg-gray-50/50 p-6 rounded-2xl border border-gray-100 gap-4 mb-2">
        <div class="flex items-center gap-4">
            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-xl hidden sm:block">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </div>
            <div>
                <h2 class="text-2xl font-black text-gray-800 tracking-tight">{{ t('dashboard_title') }}</h2>
                <div class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                    <span class="font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded">{{ total_chamados }}</span> 
                    <span>{{ t('found_tickets') }} ({{ t('page') }} {{ pagina_atual }} {{ t('of') }} {{ total_paginas }})</span>
                    {% if current_user.is_authenticated %}
                    <span class="text-gray-300">|</span>
                    <span class="inline-flex items-center text-gray-600 font-medium bg-gray-100 px-2 py-0.5 rounded-full text-xs">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        {{ current_user.nome }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto flex-col md:flex-row justify-end">
            <a href="{{ url_for('main.exportar', **request.args) }}"
                class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 font-semibold rounded-xl transition justify-center text-sm shadow-sm group">
                <svg class="w-5 h-5 mr-2 text-green-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                {{ t('export') }}
            </a>
            {% if current_user.is_authenticated and current_user.perfil in ['admin', 'supervisor'] %}
            <a href="{{ url_for('main.exportar_avancado', **request.args) }}"
                class="inline-flex items-center px-4 py-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-200 font-semibold rounded-xl transition justify-center text-sm shadow-sm group"
                title="Exportar relatÃ³rio profissional com mÃºltiplas abas">
                <svg class="w-5 h-5 mr-2 text-emerald-500 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                {{ t('reports') }}
            </a>
            {% endif %}

            {% if current_user.is_authenticated %}
            <a href="{{ url_for('main.logout') }}"
                class="inline-flex items-center px-3 py-2 text-gray-400 hover:text-red-600 hover:bg-red-50 font-medium rounded-xl transition justify-center text-sm ml-1" title="{{ t('logout') }}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- DicionÃ¡rio de TraduÃ§Ã£o para JavaScript -->
    <script>
        // Mapeamento de setores para chaves de traduÃ§Ã£o
        const sectorMap = {
            'Manutencao': '{{ t("maintenance") }}',
            'Engenharia': '{{ t("engineering") }}',
            'Qualidade': '{{ t("quality") }}',
            'Comercial': '{{ t("commercial") }}',
            'Planejamento': '{{ t("planning") }}',
            'Material': '{{ t("indirect_material") }}'
        };

        // Mapeamento de categorias para chaves de traduÃ§Ã£o
        const categoryMap = {
            'Projetos': '{{ t("projects") }}',
            'Nao Aplicavel': '{{ t("not_applicable") }}'
        };

        // Mapeamento de status para chaves de traduÃ§Ã£o
        const statusMap = {
            'Aberto': '{{ t("option_open") }}',
            'Em Atendimento': '{{ t("option_in_progress") }}',
            'ConcluÃ­do': '{{ t("option_completed") }}'
        };

        // FunÃ§Ã£o auxiliar para  traduzir setores e categorias
        function translateSector(sectorName) {
            return sectorMap[sectorName] || sectorName;
        }

        function translateCategory(categoryName) {
            return categoryMap[categoryName] || categoryName;
        }

        function translateStatus(statusName) {
            return statusMap[statusName] || statusName;
        }

        // ========================================
        // FunÃ§Ãµes do Modal - DefiniÃ§Ã£o Inline
        // ========================================
        // Garantir que as funÃ§Ãµes estejam sempre disponÃ­veis,
        // independente do carregamento do arquivo externo
        
        window.abrirModal = function(botao) {
            console.log('ðŸ”µ abrirModal chamado');
            const dados = {
                id: botao.dataset.id,
                numero: botao.dataset.numero,
                categoria: botao.dataset.categoria,
                tipo: botao.dataset.tipo,
                gate: botao.dataset.gate,
                data_abertura: botao.dataset.data,
                responsavel: botao.dataset.responsavel,
                solicitante_nome: botao.dataset.solicitanteNome,
                descricao: botao.dataset.descricao,
                rl_codigo: botao.dataset.rl,
                anexo: botao.dataset.anexo,
                anexos: botao.dataset.anexos,
                status: botao.dataset.status
            };

            // Preenche os dados bÃ¡sicos
            document.getElementById('modal-titulo').innerText = 'Visualizando Chamado ' + dados.numero;
            document.getElementById('modal-categoria').innerText = translateCategory(dados.categoria);
            document.getElementById('modal-setor').innerText = translateSector(dados.tipo);
            document.getElementById('modal-data').innerText = dados.data_abertura;
            document.getElementById('modal-autor').innerText = dados.solicitante_nome || dados.responsavel;

            // DescriÃ§Ã£o
            var descTextarea = document.getElementById('modal-descricao');
            if (descTextarea) descTextarea.value = dados.descricao;

            // RL
            var elRl = document.getElementById('modal-rl-container');
            var txtRl = document.getElementById('modal-rl-texto');
            if (dados.rl_codigo && dados.rl_codigo !== 'None' && dados.rl_codigo !== '') {
                txtRl.innerText = 'CÃ³digo RL: ' + dados.rl_codigo;
                elRl.classList.remove('hidden');
            } else {
                elRl.classList.add('hidden');
            }

            // Anexos
            var divAnexos = document.getElementById('modal-area-anexos');
            var listaAnexos = document.getElementById('modal-lista-anexos');
            if (listaAnexos) listaAnexos.innerHTML = '';
            
            var listaAnexosArray = [];
            if (dados.anexos && dados.anexos !== 'None' && dados.anexos !== '') {
                listaAnexosArray = dados.anexos.split(',');
            } else if (dados.anexo && dados.anexo !== 'None' && dados.anexo !== '') {
                listaAnexosArray = [dados.anexo];
            }

            if (listaAnexosArray.length > 0 && divAnexos && listaAnexos) {
                listaAnexosArray.forEach(function(anx) {
                    var link = document.createElement('a');
                    link.href = '/static/uploads/' + anx;
                    link.target = '_blank';
                    link.className = 'inline-flex flex-wrap items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-gray-50 mr-2 mb-2 max-w-full truncate';
                    link.innerText = 'ðŸ“Ž Baixar Anexo (' + anx + ')';
                    link.title = anx;
                    listaAnexos.appendChild(link);
                });
                divAnexos.classList.remove('hidden');
            } else if (divAnexos) {
                divAnexos.classList.add('hidden');
            }

            // Status e responsÃ¡vel
            var statusDisplayEl = document.getElementById('modal-status-display');
            var statusSelectEl = document.getElementById('select-status-modal');
            var responsavelDisplayEl = document.getElementById('modal-responsavel-display');
            var responsavelSelectEl = document.getElementById('select-responsavel-modal');
            var inputIdEl = document.getElementById('input-chamado-id');

            if (inputIdEl) inputIdEl.value = dados.id;

            if (statusDisplayEl) {
                statusDisplayEl.innerText = translateStatus(dados.status || 'Aberto');
                statusDisplayEl.className = 'inline-flex px-3 py-1 rounded-full text-sm font-bold';
                if (dados.status === 'ConcluÃ­do') {
                    statusDisplayEl.classList.add('bg-green-100', 'text-green-800');
                } else if (dados.status === 'Em Atendimento') {
                    statusDisplayEl.classList.add('bg-yellow-100', 'text-yellow-800');
                } else {
                    statusDisplayEl.classList.add('bg-gray-100', 'text-gray-800');
                }
            }

            if (statusSelectEl) statusSelectEl.value = dados.status;
            if (responsavelDisplayEl) responsavelDisplayEl.innerText = dados.responsavel || 'Nenhum';
            if (responsavelSelectEl) responsavelSelectEl.value = '';

            // Exibe o modal
            var modal = document.getElementById('modal-overlay');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.fecharModal = function() {
            var modal = document.getElementById('modal-overlay');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            var modal = document.getElementById('modal-overlay');
            if (event.target === modal) {
                window.fecharModal();
            }
        };

        console.log('âœ… FunÃ§Ãµes do modal definidas inline');
    </script>

    <form method="GET" action="{{ url_for('main.admin') }}" class="space-y-4">
        <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm relative overflow-hidden">
            <!-- Detalhe decorativo -->
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-indigo-500 rounded-l-2xl"></div>
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-5 items-end pl-2">

                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('search') }}</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </span>
                        <input type="text" name="search" value="{{ request.args.get('search', '') }}"
                            placeholder="Buscar ID, RL..."
                            class="pl-9 block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors">
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('category') }}</label>
                    <select name="categoria"
                        class="block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors px-3">
                        <option value="">{{ t('all') }}</option>
                        <option value="Projetos" {% if request.args.get('categoria')=='Projetos' %}selected{% endif %}>
                            {{ t('projects') }}</option>
                        <option value="Nao Aplicavel" {% if request.args.get('categoria')=='Nao Aplicavel' %}selected{%
                            endif %}>{{ t('not_applicable') }}</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('status') }}</label>
                    <select name="status"
                        class="block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors px-3">
                        <option value="">{{ t('all') }}</option>
                        <option value="Aberto" {% if request.args.get('status')=='Aberto' %}selected{% endif %}>{{ t('open') }}</option>
                        <option value="Em Atendimento" {% if request.args.get('status')=='Em Atendimento' %}selected{% endif %}>{{ t('in_progress') }}</option>
                        <option value="ConcluÃ­do" {% if request.args.get('status')=='ConcluÃ­do' %}selected{% endif %}>{{ t('completed') }}</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">{{ t('assigned_to') }}</label>
                    <select name="responsavel"
                        class="block w-full rounded-xl border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 sm:text-sm h-11 transition-colors px-3">
                        <option value="">{{ t('all') }}</option>
                        {% for nome in lista_responsaveis %}
                        <option value="{{ nome }}" {% if request.args.get('responsavel')==nome %}selected{% endif %}>{{ nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="md:col-span-3 flex space-x-2">
                    <button type="submit"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl shadow-sm h-11 transition-colors flex items-center justify-center gap-2">
                        <span>{{ t('filter') }}</span>
                    </button>
                    <a href="{{ url_for('main.admin') }}"
                        class="bg-gray-50 hover:bg-gray-200 text-gray-500 hover:text-gray-700 font-bold w-11 rounded-xl h-11 flex items-center justify-center transition-colors"
                        title="{{ t('clear_filters') }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </a>
                </div>
            </div>
        </div>


    </form>

    <div id="bulk-bar"
        class="hidden mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg flex flex-wrap items-center gap-3">
        <span class="text-sm font-medium text-blue-900">{{ t('bulk_change_status') }}:</span>
        <select id="bulk-status"
            class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 border px-2 py-1">
            <option value="Aberto">{{ t('open') }}</option>
            <option value="Em Atendimento">{{ t('in_progress') }}</option>
            <option value="ConcluÃ­do">{{ t('completed') }}</option>
        </select>
        <button type="button" id="bulk-apply"
            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition">{{
            t('apply') }}</button>
        <span id="bulk-count" class="text-sm text-blue-700"></span>
    </div>

    <div class="bg-white shadow-sm rounded-2xl overflow-hidden border border-gray-100 p-1">
        <table class="min-w-full divide-y divide-gray-100">
            <thead class="bg-gray-50/50">
                <tr>
                    <th class="px-5 py-4 text-left">
                        <input type="checkbox" id="bulk-select-all"
                            class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                            title="{{ t('select_all') }}">
                    </th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('id_ref') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('category') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('sector_gate') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('assigned_to') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('description') }}</th>
                    <th class="px-5 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('status') }}</th>
                    <th class="px-5 py-4 text-center text-xs font-bold text-gray-400 uppercase tracking-widest">{{ t('actions') }}</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-50/80 gsap-stagger-container">
                {% if chamados %}
                {% for chamado in chamados %}
                <tr
                    class="gsap-stagger hover:bg-indigo-50/50 transition duration-150 group cursor-default {% if chamado.categoria == 'Projetos' %}bg-red-50/20{% endif %}">
                    <td class="px-5 py-4 whitespace-nowrap">
                        <input type="checkbox" class="bulk-cb rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                            value="{{ chamado.id }}" data-id="{{ chamado.id }}">
                    </td>
                    <td class="px-5 py-4 whitespace-nowrap">
                        <div class="text-sm font-black text-gray-800">{{ chamado.numero_chamado }}</div>
                        {% if chamado.rl_codigo %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-pink-100 text-pink-700 mt-1 uppercase tracking-wider">
                            {{ t('rl_short') }} {{ chamado.rl_codigo }}
                        </span>
                        {% endif %}
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap">
                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-bold rounded-lg 
                                {% if chamado.categoria == 'Projetos' %}bg-pink-100 text-pink-700{% else %}bg-indigo-100 text-indigo-700{% endif %}">
                            {{ translate_category(chamado.categoria) }}
                        </span>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap">
                        <div class="text-sm font-semibold text-gray-800">{{ translate_sector(chamado.tipo_solicitacao) }}</div>
                        <div class="text-xs font-medium text-gray-400">{{ chamado.gate }}</div>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            {% if chamado.responsavel %}
                            <div class="h-6 w-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold mr-2">
                                {{ chamado.responsavel[0] }}
                            </div>
                            {% endif %}
                            <span class="text-sm font-medium text-gray-700">{{ chamado.responsavel or 'NÃ£o atribuÃ­do' }}</span>
                        </div>
                    </td>

                    <td class="px-5 py-4">
                        <div class="text-sm text-gray-700 truncate max-w-[200px] cursor-pointer group-hover:text-indigo-600 font-medium"
                            title="{{ t('click_eye_full') }}">
                            {{ chamado.descricao[:30] }}{% if chamado.descricao|length > 30 %}...{% endif %}
                        </div>
                        <div class="text-xs text-gray-400 font-medium mt-0.5">
                            {{ chamado.data_abertura_formatada() }}
                        </div>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap">
                        <span class="px-2.5 py-1 inline-flex text-xs leading-5 font-bold rounded-lg 
                                {% if chamado.status == 'ConcluÃ­do' %}bg-emerald-100 text-emerald-700{% elif chamado.status == 'Em Atendimento' %}bg-amber-100 text-amber-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                            <span class="w-1.5 h-1.5 rounded-full mr-1.5 mt-1.5 {% if chamado.status == 'ConcluÃ­do' %}bg-emerald-500{% elif chamado.status == 'Em Atendimento' %}bg-amber-500{% else %}bg-blue-500{% endif %}"></span>
                            {{ translate_status(chamado.status or 'Aberto') }}
                        </span>
                    </td>

                    <td class="px-5 py-4 whitespace-nowrap text-sm font-medium flex items-center justify-center space-x-2">
                        <button onclick="abrirModal(this)" data-id="{{ chamado.id }}"
                            data-numero="{{ chamado.numero_chamado }}" data-categoria="{{ chamado.categoria }}"
                            data-tipo="{{ chamado.tipo_solicitacao }}" data-gate="{{ chamado.gate }}"
                            data-data="{{ chamado.data_abertura_formatada() }}"
                            data-responsavel="{{ chamado.responsavel }}"
                            data-solicitante-nome="{{ chamado.solicitante_nome }}"
                            data-descricao="{{ chamado.descricao }}" data-rl="{{ chamado.rl_codigo or '' }}"
                            data-anexo="{{ chamado.anexo or '' }}"
                            data-anexos="{{ ','.join(chamado.anexos) if chamado.anexos else '' }}"
                            data-status="{{ chamado.status }}"
                            class="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                            title="{{ t('view_details') }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>

                        <a href="{{ url_for('main.visualizar_historico', chamado_id=chamado.id) }}"
                            class="p-1.5 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors"
                            title="{{ t('view_history') }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-10 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center">
                            <svg class="w-12 h-12 text-gray-300 mb-3" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                </path>
                            </svg>
                            <p class="text-lg font-medium">{{ t('no_tickets') }}</p>
                            <p class="text-sm">{{ t('no_tickets_hint') }}</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- PaginaÃ§Ã£o -->
    {% if total_paginas > 1 %}
    <div
        class="flex flex-col md:flex-row justify-between items-center bg-gray-50/50 p-4 rounded-2xl border border-gray-100 gap-4 mt-6">
        <div class="text-sm text-gray-500 font-medium">
            {{ t('showing') }} <span class="font-bold text-gray-800">{{ (pagina_atual - 1) * itens_por_pagina + 1 }}</span> {{
            t('to') }}
            <span class="font-bold text-gray-800">{{ [pagina_atual * itens_por_pagina, total_chamados]|min }}</span>
            {{ t('of') }} <span class="font-bold text-gray-800">{{ total_chamados }}</span> {{ t('found_tickets') }}
        </div>

        <div class="flex items-center gap-1 bg-white border border-gray-200 rounded-xl p-1 shadow-sm">
            {% if pagina_atual > 1 %}
            <a href="{{ url_for('main.admin', pagina=1, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('first') }}">
                Â«
            </a>
            <a href="{{ url_for('main.admin', pagina=pagina_atual-1, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('previous') }}">
                â€¹
            </a>
            {% endif %}

            <!-- NÃºmeros das PÃ¡ginas -->
            {% for p in range(max(1, pagina_atual - 2), min(total_paginas + 1, pagina_atual + 3)) %}
            {% if p == pagina_atual %}
            <button disabled
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-bold text-white bg-indigo-600 shadow-sm">
                {{ p }}
            </button>
            {% else %}
            <a href="{{ url_for('main.admin', pagina=p, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors">
                {{ p }}
            </a>
            {% endif %}
            {% endfor %}

            {% if pagina_atual < total_paginas %} <a
                href="{{ url_for('main.admin', pagina=pagina_atual+1, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('next') }}">
                â€º
                </a>
                <a href="{{ url_for('main.admin', pagina=total_paginas, search=request.args.get('search', ''), categoria=request.args.get('categoria', ''), status=request.args.get('status', ''), gate=request.args.get('gate', '')) }}"
                    class="w-8 h-8 flex items-center justify-center rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition-colors" title="{{ t('last') }}">
                    Â»
                </a>
                {% endif %}
        </div>
    </div>
    {% endif %}

    <div id="modal-overlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl mx-4 overflow-hidden transform transition-all">

            <div class="bg-gradient-to-r from-blue-800 to-blue-900 px-6 py-4 flex justify-between items-center">
                <div>
                    <h3 id="modal-titulo" class="text-xl font-bold text-white">{{ t('viewing_chamado') }}</h3>
                    <p class="text-blue-200 text-sm">{{ t('complete_details') }}</p>
                </div>
                <button onclick="fecharModal()" class="text-white hover:text-gray-300 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 space-y-4 border-r border-gray-100 pr-4">
                    <div class="flex space-x-2 mb-2">
                        <span id="modal-categoria"
                            class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs font-bold uppercase"></span>
                        <span id="modal-setor"
                            class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-bold uppercase"></span>
                        <div id="modal-rl-container" class="hidden">
                            <span id="modal-rl-texto"
                                class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-bold"></span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">{{
                            t('problem_description') }}</label>
                        <textarea id="modal-descricao" name="nova_descricao" rows="10"
                            class="mt-1 w-full text-gray-800 bg-white p-3 rounded-md border border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm leading-relaxed resize-y"
                            placeholder="Edite ou adicione texto Ã  descriÃ§Ã£o existente..."></textarea>
                    </div>
                    <div id="modal-area-anexos" class="mb-2 hidden">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Anexos
                            Atuais</label>
                        <div id="modal-lista-anexos" class="space-y-2"></div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Novo Anexo
                            (Adicionar)</label>
                        <input type="file" id="modal-input-anexo" name="anexo"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition border border-gray-300 rounded-md">
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-md border border-blue-100">
                        <h4 class="font-bold text-blue-900 text-sm mb-3">{{ t('opening_info') }}</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="text-gray-500">{{ t('date') }}:</span> <span id="modal-data"
                                    class="font-medium"></span></p>
                            <p><span class="text-gray-500">{{ t('requester') }}:</span> <span id="modal-autor"
                                    class="font-medium"></span></p>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                        <h4 class="font-bold text-gray-900 text-sm mb-3">{{ t('ticket_details') }}</h4>
                        <!-- FormulÃ¡rio centralizado no modal para ediÃ§Ãµes (DescriÃ§Ã£o, Status, ResponsÃ¡vel, Anexo) estÃ¡ pegando os controles externos pelo atributo "form" via JS -->
                        <form id="form-status-modal" action="/api/editar-chamado" method="POST"
                            enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <input type="hidden" id="input-chamado-id" name="chamado_id">

                            <div class="mb-3">
                                <label class="block text-xs text-gray-500 mb-1">{{ t('current_status') }}</label>
                                <span id="modal-status-display"
                                    class="inline-flex px-3 py-1 rounded-full text-sm font-bold"></span>

                                <label class="block text-xs text-gray-500 mt-2 mb-1">{{ t('change_status_to') }}</label>
                                <select id="select-status-modal" name="novo_status"
                                    class="block w-full pl-3 pr-10 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md border bg-white mb-2">
                                    <option value="Aberto">{{ t('option_open') }}</option>
                                    <option value="Em Atendimento">{{ t('option_in_progress') }}</option>
                                    <option value="ConcluÃ­do">{{ t('option_completed') }}</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="block text-xs text-gray-500 mb-1">{{ t('responsible') }}</label>
                                <span id="modal-responsavel-display"
                                    class="text-sm font-medium text-gray-900 block mb-2"></span>
                                <select id="select-responsavel-modal" name="novo_responsavel_id"
                                    class="block w-full pl-3 pr-10 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md border bg-white">
                                    <option value="">Sem alteraÃ§Ã£o</option>
                                    {% for sup in supervisores_detalhados %}
                                    <option value="{{ sup.id }}">{{ sup.nome }} ({{ sup.area }})</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="border-t border-gray-300 pt-3 mt-3">
                                <button type="submit" id="btn-submit-status"
                                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-900 hover:bg-blue-800 focus:outline-none transition">
                                    {{ t('save_change') }}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block page_scripts %}
    <!-- As funÃ§Ãµes abrirModal e fecharModal jÃ¡ estÃ£o definidas inline acima -->
    <script src="{{ url_for('static', filename='js/dashboard_otimizacoes.js') }}?v=4"></script>
    
    <script>
        // Interceptar submit do formulÃ¡rio de status no modal para enviar via AJAX
        (function () {
            var formStatus = document.getElementById('form-status-modal');
            if (formStatus) {
                formStatus.addEventListener('submit', function (e) {
                    e.preventDefault();

                    // Coleta os dados do formulÃ¡rio
                    var formData = new FormData(formStatus);
                    // Anexar textarea caso esteja fora do form (na nossa estrutura atual, ele estaria fora se nÃ£o movermos)
                    var textareaDesc = document.getElementById('modal-descricao');
                    if (textareaDesc) {
                        formData.set('nova_descricao', textareaDesc.value);
                    }
                    var inputFile = document.getElementById('modal-input-anexo');
                    if (inputFile && inputFile.files.length > 0) {
                        formData.set('anexo', inputFile.files[0]);
                    }

                    var btnSubmit = document.getElementById('btn-submit-status');

                    // Desabilita botÃ£o
                    if (btnSubmit) {
                        btnSubmit.disabled = true;
                        btnSubmit.innerText = 'Salvando...';
                    }

                    // Envia via AJAX para a API (CSRF no header)
                    var csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    var headers = {};
                    if (csrfMeta && csrfMeta.content) headers['X-CSRFToken'] = csrfMeta.content;
                    fetch('/api/editar-chamado', {
                        method: 'POST',
                        headers: headers,
                        body: formData
                    })
                        .then(function (response) {
                            return response.json();
                        })
                        .then(function (data) {
                            if (data.sucesso) {
                                window.location.reload();
                            } else {
                                alert('Erro: ' + (data.erro || 'Desconhecido'));
                                if (btnSubmit) { btnSubmit.disabled = false; btnSubmit.innerText = 'Salvar AlteraÃ§Ã£o'; }
                            }
                        })
                        .catch(function (error) {
                            console.error('âŒ Erro ao editar chamado:', error);
                            alert('Erro de rede ao salvar!');
                            if (btnSubmit) { btnSubmit.disabled = false; btnSubmit.innerText = 'Salvar AlteraÃ§Ã£o'; }
                        });
                });
            }
        })();


        (function () {
            var bulkBar = document.getElementById('bulk-bar');
            var bulkSelectAll = document.getElementById('bulk-select-all');
            var bulkStatus = document.getElementById('bulk-status');
            var bulkApply = document.getElementById('bulk-apply');
            var bulkCount = document.getElementById('bulk-count');
            function updateBulkBar() {
                var cbs = document.querySelectorAll('.bulk-cb:checked');
                var n = cbs.length;
                if (n > 0) {
                    bulkBar.classList.remove('hidden');
                    bulkCount.textContent = n + ' selecionado(s)';
                } else {
                    bulkBar.classList.add('hidden');
                    if (bulkSelectAll) bulkSelectAll.checked = false;
                }
            }
            if (bulkSelectAll) {
                bulkSelectAll.addEventListener('change', function () {
                    document.querySelectorAll('.bulk-cb').forEach(function (cb) { cb.checked = bulkSelectAll.checked; });
                    updateBulkBar();
                });
            }
            document.querySelectorAll('.bulk-cb').forEach(function (cb) {
                cb.addEventListener('change', updateBulkBar);
            });
            if (bulkApply) {
                bulkApply.addEventListener('click', function () {
                    var ids = [];
                    document.querySelectorAll('.bulk-cb:checked').forEach(function (cb) { ids.push(cb.value); });
                    if (ids.length === 0) return;
                    var status = bulkStatus ? bulkStatus.value : 'ConcluÃ­do';
                    bulkApply.disabled = true;
                    var csrfInput = document.querySelector('input[name="csrf_token"]');
                    var csrfMeta = document.querySelector('meta[name="csrf-token"]');
                    var headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
                    if (csrfInput) headers['X-CSRFToken'] = csrfInput.value;
                    else if (csrfMeta && csrfMeta.content) headers['X-CSRFToken'] = csrfMeta.content;
                    fetch('{{ url_for("main.bulk_atualizar_status") }}', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ chamado_ids: ids, novo_status: status })
                    }).then(function (r) { return r.json(); }).then(function (data) {
                        if (data.sucesso) {
                            window.location.reload();
                        } else {
                            alert(data.erro || 'Erro ao atualizar');
                            bulkApply.disabled = false;
                        }
                    }).catch(function () {
                        alert('Erro de rede');
                        bulkApply.disabled = false;
                    });
                });
            }
        })();
    </script>

    {% endblock %}