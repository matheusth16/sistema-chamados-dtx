{% extends "base.html" %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">{{ t('translation_management') }}</h1>
        <p class="text-gray-500 mt-1">{{ t('edit_system_terms') }}</p>
    </div>
</div>

<div class="bg-white shadow-sm rounded-lg overflow-hidden border border-gray-200">
    <div class="p-4 border-b border-gray-200 bg-gray-50 mb-2">
        <input type="text" id="searchInput" placeholder="{{ t('search_key_or_text') }}" class="w-full md:w-1/3 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('system_key') }}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('portuguese_pt_br') }}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('english_en') }}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('spanish_es') }}</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">{{ t('actions') }}</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="translationsTable">
                {% for chave, langs in translations.items() %}
                <tr class="translation-row hover:bg-gray-50 transition">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 chave-cell">{{ chave }}</td>
                    <td class="px-6 py-4">
                        <input type="text" value="{{ langs.get('pt_BR', '') }}" class="w-full min-w-[150px] border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-2 py-1 border trans-input" data-lang="pt_BR">
                    </td>
                    <td class="px-6 py-4">
                        <input type="text" value="{{ langs.get('en', '') }}" class="w-full min-w-[150px] border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-2 py-1 border trans-input" data-lang="en">
                    </td>
                    <td class="px-6 py-4">
                        <input type="text" value="{{ langs.get('es', '') }}" class="w-full min-w-[150px] border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-2 py-1 border trans-input" data-lang="es">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="save-btn inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            {{ t('save') }}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Busca simples
    const searchInput = document.getElementById('searchInput');
    const rows = document.querySelectorAll('.translation-row');
    
    searchInput.addEventListener('keyup', function(e) {
        const term = e.target.value.toLowerCase();
        rows.forEach(row => {
            const textContent = row.textContent.toLowerCase();
            const inputs = Array.from(row.querySelectorAll('input')).map(i => i.value.toLowerCase()).join(' ');
            if (textContent.includes(term) || inputs.includes(term)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Salvar Tradução via AJAX
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const chave = row.querySelector('.chave-cell').textContent.trim();
            const ptBR = row.querySelector('input[data-lang="pt_BR"]').value;
            const en = row.querySelector('input[data-lang="en"]').value;
            const es = row.querySelector('input[data-lang="es"]').value;
            
            const originalText = this.innerHTML;
            this.innerHTML = `{{ t('saving') }}`;
            this.disabled = true;
            this.classList.replace('bg-blue-600', 'bg-blue-400');
            
            const formData = new URLSearchParams();
            formData.append('chave', chave);
            formData.append('pt_BR', ptBR);
            formData.append('en', en);
            formData.append('es', es);
            
            fetch("{{ url_for('main.admin_traducoes') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: formData.toString()
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    this.innerHTML = `✓ {{ t('saved') }}`;
                    this.classList.replace('bg-blue-400', 'bg-green-600');
                    setTimeout(() => {
                        this.innerHTML = `{{ t('save') }}`;
                        this.classList.replace('bg-green-600', 'bg-blue-600');
                        this.disabled = false;
                    }, 2000);
                } else {
                    alert(`{{ t('error_saving') }}: ` + (data.erro || `{{ t('unknown') }}`));
                    this.innerHTML = `{{ t('error') }}`;
                    this.classList.replace('bg-blue-400', 'bg-red-600');
                    setTimeout(() => {
                        this.innerHTML = `{{ t('save') }}`;
                        this.classList.replace('bg-red-600', 'bg-blue-600');
                        this.disabled = false;
                    }, 2000);
                }
            })
            .catch(err => {
                console.error(err);
                alert(`{{ t('error_in_request_console') }}`);
                this.innerHTML = `{{ t('save') }}`;
                this.classList.replace('bg-blue-400', 'bg-blue-600');
                this.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}
