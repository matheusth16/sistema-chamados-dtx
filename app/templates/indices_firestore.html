{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h1>‚ö° √çndices Firestore - Status e Implementa√ß√£o</h1>
            
            <div class="alert alert-info mt-4">
                <h5>üìä Resumen de Otimiza√ß√µes Implementadas</h5>
                <ul>
                    <li><strong>‚úÖ Pagina√ß√£o por Cursor:</strong> Busca apenas 50 documentos por requisi√ß√£o</li>
                    <li><strong>‚úÖ Carregar Mais:</strong> Bot√£o para carregar pr√≥ximos registros sem reload</li>
                    <li><strong>‚úÖ Status AJAX:</strong> Atualiza status sem recarregar a p√°gina inteira</li>
                    <li><strong>‚è≥ √çndices Firestore:</strong> Faltam criar para m√°xima performance</li>
                </ul>
            </div>

            <h2 class="mt-5">üìã √çndices Recomendados</h2>
            
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Descri√ß√£o</th>
                        <th>Campos</th>
                        <th>Uso</th>
                    </tr>
                </thead>
                <tbody>
                    {% for indice in indices %}
                    <tr>
                        <td><strong>{{ loop.index }}</strong></td>
                        <td>{{ indice.descricao }}</td>
                        <td>
                            <small>
                                {% for campo, ordem in indice.campos %}
                                    <code>{{ campo }}</code> <span class="badge bg-secondary">{{ ordem }}</span><br>
                                {% endfor %}
                            </small>
                        </td>
                        <td>
                            {% if loop.index == 1 %}
                                Filtrar por categoria + status
                            {% elif loop.index == 2 %}
                                Filtrar por status apenas
                            {% elif loop.index == 3 %}
                                Filtrar por categoria + prioridade
                            {% else %}
                                Filtrar por gate + status
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h2 class="mt-5">üöÄ Como Criar os √çndices</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5>Op√ß√£o 1: Firebase Console (Recomendado)</h5>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>V√° para: <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                                <li>Firestore Database ‚Üí <strong>√çndices</strong></li>
                                <li>Clique em <strong>Create Index</strong></li>
                                <li>Preencha com os dados da tabela acima</li>
                                <li>Espere ~5 minutos por √≠ndice</li>
                            </ol>
                            <hr>
                            <p><strong>‚è±Ô∏è Tempo total:</strong> ~20 minutos para 4 √≠ndices</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5>Op√ß√£o 2: Firebase CLI (Mais r√°pido)</h5>
                        </div>
                        <div class="card-body">
                            <ol>
                                <li>Abra Terminal na pasta do projeto</li>
                                <li>
                                    <code>firebase deploy --only firestore:indexes --project seu-projeto-id</code>
                                </li>
                                <li>Espere concluir (~1-2 minutos)</li>
                                <li>Pronto! Todos os √≠ndices criados de uma vez</li>
                            </ol>
                            <hr>
                            <p><strong>‚è±Ô∏è Tempo total:</strong> ~10 minutos</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="mt-5">üìÅ Arquivo firestore.indexes.json</h2>
            
            <div class="card">
                <div class="card-header">
                    <strong>Localiza√ß√£o:</strong> <code>firestore.indexes.json</code> (raiz do projeto)
                </div>
                <div class="card-body">
                    <p><strong>‚úÖ Status:</strong> Arquivo j√° criado! Pronto para deploy.</p>
                    <pre><code>{{ script }}</code></pre>
                </div>
            </div>

            <h2 class="mt-5">üìä Impacto de Performance</h2>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-header bg-danger text-white">
                            <h5>‚ùå Sem √çndices</h5>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li>Query com 3 filtros: <strong>2-5 segundos</strong></li>
                                <li>Leitura de documentos: <strong>1000+ ops</strong></li>
                                <li>Custo Firestore: <strong>Alto</strong></li>
                                <li>Experi√™ncia do usu√°rio: <strong>Lenta</strong> ‚è≥</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-header bg-success text-white">
                            <h5>‚úÖ Com √çndices</h5>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li>Query com 3 filtros: <strong>50-200ms</strong></li>
                                <li>Leitura de documentos: <strong>50-100 ops</strong></li>
                                <li>Custo Firestore: <strong>10x menor</strong></li>
                                <li>Experi√™ncia do usu√°rio: <strong>R√°pida</strong> ‚ö°</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="mt-5">‚úÖ Checklist de Implementa√ß√£o</h2>
            
            <div class="card">
                <div class="card-body">
                    <form>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check1">
                            <label class="form-check-label" for="check1">
                                ‚òëÔ∏è Criar <code>firestore.indexes.json</code> (j√° feito!)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check2">
                            <label class="form-check-label" for="check2">
                                ‚òëÔ∏è Deploy √≠ndices via Firebase Console ou CLI
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check3">
                            <label class="form-check-label" for="check3">
                                ‚òëÔ∏è Esperar ~15 minutos para √≠ndices ficarem "Ready"
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check4">
                            <label class="form-check-label" for="check4">
                                ‚òëÔ∏è Testar pagina√ß√£o em /admin
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check5">
                            <label class="form-check-label" for="check5">
                                ‚òëÔ∏è Monitorar performance no Firestore Console
                            </label>
                        </div>
                    </form>
                </div>
            </div>

            <h2 class="mt-5">üîß APIs Otimizadas Dispon√≠veis</h2>
            
            <div class="card mt-4">
                <div class="card-header bg-dark text-white">
                    <h5>1. GET /api/chamados/paginar</h5>
                </div>
                <div class="card-body">
                    <p><strong>Descri√ß√£o:</strong> Pagina√ß√£o com cursor - busca apenas 50 documentos</p>
                    <p><strong>Query params:</strong></p>
                    <pre><code>
cursor=abc123         # ID do √∫ltimo documento (opcional)
limite=50             # Documentos por p√°gina (padr√£o: 50, m√°x: 100)
status=Aberto         # Filtrar por status
categoria=Projetos    # Filtrar por categoria
gate=G1               # Filtrar por gate
search=termo          # Busca full-text
                    </code></pre>
                    <p><strong>Response:</strong></p>
                    <pre><code>
{
  "sucesso": true,
  "chamados": [...],
  "paginacao": {
    "cursor_proximo": "id123",
    "tem_proxima": true,
    "total_pagina": 50,
    "limite": 50
  }
}
                    </code></pre>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header bg-dark text-white">
                    <h5>2. POST /api/carregar-mais</h5>
                </div>
                <div class="card-body">
                    <p><strong>Descri√ß√£o:</strong> Carregar mais registros (infinite scroll)</p>
                    <p><strong>Body (JSON):</strong></p>
                    <pre><code>
{
  "cursor": "abc123",
  "limite": 20
}
                    </code></pre>
                    <p><strong>Response:</strong></p>
                    <pre><code>
{
  "sucesso": true,
  "chamados": [...],
  "cursor_proximo": "xyz789",
  "tem_proxima": true
}
                    </code></pre>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header bg-dark text-white">
                    <h5>3. POST /api/atualizar-status</h5>
                </div>
                <div class="card-body">
                    <p><strong>Descri√ß√£o:</strong> Atualizar status sem recarregar a p√°gina</p>
                    <p><strong>Body (JSON):</strong></p>
                    <pre><code>
{
  "chamado_id": "abc123",
  "novo_status": "Conclu√≠do"
}
                    </code></pre>
                    <p><strong>Response:</strong></p>
                    <pre><code>
{
  "sucesso": true,
  "mensagem": "Status alterado para Conclu√≠do",
  "novo_status": "Conclu√≠do"
}
                    </code></pre>
                </div>
            </div>

            <h2 class="mt-5">üìö Refer√™ncias</h2>
            
            <ul>
                <li><a href="https://firebase.google.com/docs/firestore/query-data/indexing" target="_blank">Firestore Indexes Documentation</a></li>
                <li><a href="https://firebase.google.com/docs/firestore/query-data/query-cursors" target="_blank">Query Cursors Guide</a></li>
                <li><a href="https://firebase.google.com/docs/firestore/best-practices" target="_blank">Firestore Best Practices</a></li>
            </ul>

        </div>
    </div>
</div>

<style>
    code {
        background-color: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    pre {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        overflow-x: auto;
    }
    
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
</style>
{% endblock %}
